{"version":3,"file":"module-types.min.js","sources":["../../src/common.js","../../src/extras/module-types.js"],"sourcesContent":["import { errMsg } from './err-msg.js';\r\n\r\nexport var hasSymbol = typeof Symbol !== 'undefined';\r\nexport var hasSelf = typeof self !== 'undefined';\r\nexport var hasDocument = typeof document !== 'undefined';\r\n\r\nvar envGlobal = hasSelf ? self : global;\r\nexport { envGlobal as global };\r\n\r\n// Loader-scoped baseUrl and import map supported in Node.js only\r\nexport var BASE_URL = hasSymbol ? Symbol() : '_';\r\nexport var IMPORT_MAP = hasSymbol ? Symbol() : '#';\r\n\r\nexport var baseUrl;\r\n\r\nif (hasDocument) {\r\n  var baseEl = document.querySelector('base[href]');\r\n  if (baseEl)\r\n    baseUrl = baseEl.href;\r\n}\r\n\r\nif (!baseUrl && typeof location !== 'undefined') {\r\n  baseUrl = location.href.split('#')[0].split('?')[0];\r\n  var lastSepIndex = baseUrl.lastIndexOf('/');\r\n  if (lastSepIndex !== -1)\r\n    baseUrl = baseUrl.slice(0, lastSepIndex + 1);\r\n}\r\n\r\nif (!process.env.SYSTEM_BROWSER && !baseUrl && typeof process !== 'undefined') {\r\n  var cwd = process.cwd();\r\n  // TODO: encoding edge cases\r\n  baseUrl = 'file://' + (cwd[0] === '/' ? '' : '/') + cwd.replace(/\\\\/g, '/') + '/';\r\n}\r\n\r\nvar backslashRegEx = /\\\\/g;\r\nexport function resolveIfNotPlainOrUrl (relUrl, parentUrl) {\r\n  if (relUrl.indexOf('\\\\') !== -1)\r\n    relUrl = relUrl.replace(backslashRegEx, '/');\r\n  // protocol-relative\r\n  if (relUrl[0] === '/' && relUrl[1] === '/') {\r\n    return parentUrl.slice(0, parentUrl.indexOf(':') + 1) + relUrl;\r\n  }\r\n  // relative-url\r\n  else if (relUrl[0] === '.' && (relUrl[1] === '/' || relUrl[1] === '.' && (relUrl[2] === '/' || relUrl.length === 2 && (relUrl += '/')) ||\r\n      relUrl.length === 1  && (relUrl += '/')) ||\r\n      relUrl[0] === '/') {\r\n    var parentProtocol = parentUrl.slice(0, parentUrl.indexOf(':') + 1);\r\n    // Disabled, but these cases will give inconsistent results for deep backtracking\r\n    //if (parentUrl[parentProtocol.length] !== '/')\r\n    //  throw Error('Cannot resolve');\r\n    // read pathname from parent URL\r\n    // pathname taken to be part after leading \"/\"\r\n    var pathname;\r\n    if (parentUrl[parentProtocol.length + 1] === '/') {\r\n      // resolving to a :// so we need to read out the auth and host\r\n      if (parentProtocol !== 'file:') {\r\n        pathname = parentUrl.slice(parentProtocol.length + 2);\r\n        pathname = pathname.slice(pathname.indexOf('/') + 1);\r\n      }\r\n      else {\r\n        pathname = parentUrl.slice(8);\r\n      }\r\n    }\r\n    else {\r\n      // resolving to :/ so pathname is the /... part\r\n      pathname = parentUrl.slice(parentProtocol.length + (parentUrl[parentProtocol.length] === '/'));\r\n    }\r\n\r\n    if (relUrl[0] === '/')\r\n      return parentUrl.slice(0, parentUrl.length - pathname.length - 1) + relUrl;\r\n\r\n    // join together and split for removal of .. and . segments\r\n    // looping the string instead of anything fancy for perf reasons\r\n    // '../../../../../z' resolved to 'x/y' is just 'z'\r\n    var segmented = pathname.slice(0, pathname.lastIndexOf('/') + 1) + relUrl;\r\n\r\n    var output = [];\r\n    var segmentIndex = -1;\r\n    for (var i = 0; i < segmented.length; i++) {\r\n      // busy reading a segment - only terminate on '/'\r\n      if (segmentIndex !== -1) {\r\n        if (segmented[i] === '/') {\r\n          output.push(segmented.slice(segmentIndex, i + 1));\r\n          segmentIndex = -1;\r\n        }\r\n      }\r\n\r\n      // new segment - check if it is relative\r\n      else if (segmented[i] === '.') {\r\n        // ../ segment\r\n        if (segmented[i + 1] === '.' && (segmented[i + 2] === '/' || i + 2 === segmented.length)) {\r\n          output.pop();\r\n          i += 2;\r\n        }\r\n        // ./ segment\r\n        else if (segmented[i + 1] === '/' || i + 1 === segmented.length) {\r\n          i += 1;\r\n        }\r\n        else {\r\n          // the start of a new segment as below\r\n          segmentIndex = i;\r\n        }\r\n      }\r\n      // it is the start of a new segment\r\n      else {\r\n        segmentIndex = i;\r\n      }\r\n    }\r\n    // finish reading out the last segment\r\n    if (segmentIndex !== -1)\r\n      output.push(segmented.slice(segmentIndex));\r\n    return parentUrl.slice(0, parentUrl.length - pathname.length) + output.join('');\r\n  }\r\n}\r\n\r\n/*\r\n * Import maps implementation\r\n *\r\n * To make lookups fast we pre-resolve the entire import map\r\n * and then match based on backtracked hash lookups\r\n *\r\n */\r\n\r\nexport function resolveUrl (relUrl, parentUrl) {\r\n  return resolveIfNotPlainOrUrl(relUrl, parentUrl) || (relUrl.indexOf(':') !== -1 ? relUrl : resolveIfNotPlainOrUrl('./' + relUrl, parentUrl));\r\n}\r\n\r\nfunction resolveAndComposePackages (packages, outPackages, baseUrl, parentMap, parentUrl) {\r\n  for (var p in packages) {\r\n    var resolvedLhs = resolveIfNotPlainOrUrl(p, baseUrl) || p;\r\n    var rhs = packages[p];\r\n    // package fallbacks not currently supported\r\n    if (typeof rhs !== 'string')\r\n      continue;\r\n    var mapped = resolveImportMap(parentMap, resolveIfNotPlainOrUrl(rhs, baseUrl) || rhs, parentUrl);\r\n    if (!mapped) {\r\n      if (process.env.SYSTEM_PRODUCTION)\r\n        targetWarning('W1', p, rhs);\r\n      else\r\n        targetWarning('W1', p, rhs, 'bare specifier did not resolve');\r\n    }\r\n    else\r\n      outPackages[resolvedLhs] = mapped;\r\n  }\r\n}\r\n\r\nexport function resolveAndComposeImportMap (json, baseUrl, outMap) {\r\n  if (json.imports)\r\n    resolveAndComposePackages(json.imports, outMap.imports, baseUrl, outMap, null);\r\n\r\n  var u;\r\n  for (u in json.scopes || {}) {\r\n    var resolvedScope = resolveUrl(u, baseUrl);\r\n    resolveAndComposePackages(json.scopes[u], outMap.scopes[resolvedScope] || (outMap.scopes[resolvedScope] = {}), baseUrl, outMap, resolvedScope);\r\n  }\r\n\r\n  for (u in json.depcache || {})\r\n    outMap.depcache[resolveUrl(u, baseUrl)] = json.depcache[u];\r\n  \r\n  for (u in json.integrity || {})\r\n    outMap.integrity[resolveUrl(u, baseUrl)] = json.integrity[u];\r\n}\r\n\r\nfunction getMatch (path, matchObj) {\r\n  if (matchObj[path])\r\n    return path;\r\n  var sepIndex = path.length;\r\n  do {\r\n    var segment = path.slice(0, sepIndex + 1);\r\n    if (segment in matchObj)\r\n      return segment;\r\n  } while ((sepIndex = path.lastIndexOf('/', sepIndex - 1)) !== -1)\r\n}\r\n\r\nfunction applyPackages (id, packages) {\r\n  var pkgName = getMatch(id, packages);\r\n  if (pkgName) {\r\n    var pkg = packages[pkgName];\r\n    if (pkg === null) return;\r\n    if (id.length > pkgName.length && pkg[pkg.length - 1] !== '/') {\r\n      if (process.env.SYSTEM_PRODUCTION)\r\n        targetWarning('W2', pkgName, pkg);\r\n      else\r\n        targetWarning('W2', pkgName, pkg, \"should have a trailing '/'\");\r\n    }\r\n    else\r\n      return pkg + id.slice(pkgName.length);\r\n  }\r\n}\r\n\r\nfunction targetWarning (code, match, target, msg) {\r\n  console.warn(errMsg(code, process.env.SYSTEM_PRODUCTION ? [target, match].join(', ') : \"Package target \" + msg + \", resolving target '\" + target + \"' for \" + match));\r\n}\r\n\r\nexport function resolveImportMap (importMap, resolvedOrPlain, parentUrl) {\r\n  var scopes = importMap.scopes;\r\n  var scopeUrl = parentUrl && getMatch(parentUrl, scopes);\r\n  while (scopeUrl) {\r\n    var packageResolution = applyPackages(resolvedOrPlain, scopes[scopeUrl]);\r\n    if (packageResolution)\r\n      return packageResolution;\r\n    scopeUrl = getMatch(scopeUrl.slice(0, scopeUrl.lastIndexOf('/')), scopes);\r\n  }\r\n  return applyPackages(resolvedOrPlain, importMap.imports) || resolvedOrPlain.indexOf(':') !== -1 && resolvedOrPlain;\r\n}\r\n","import { resolveUrl } from '../common.js';\r\n\r\n/*\r\n * Loads JSON, CSS, Wasm module types based on file extension\r\n * filters and content type verifications\r\n */\r\n(function(global) {\r\n  var systemJSPrototype = global.PentaSystem.constructor.prototype;\r\n\r\n  var moduleTypesRegEx = /^[^#?]+\\.(css|html|json|wasm)([?#].*)?$/;\r\n  systemJSPrototype.shouldFetch = function (url) {\r\n    return moduleTypesRegEx.test(url);\r\n  };\r\n\r\n  var jsonContentType = /^application\\/json(;|$)/;\r\n  var cssContentType = /^text\\/css(;|$)/;\r\n  var wasmContentType = /^application\\/wasm(;|$)/;\r\n\r\n  var fetch = systemJSPrototype.fetch;\r\n  systemJSPrototype.fetch = function (url, options) {\r\n    return fetch(url, options)\r\n    .then(function (res) {\r\n      if (options.passThrough)\r\n        return res;\r\n\r\n      if (!res.ok)\r\n        return res;\r\n      var contentType = res.headers.get('content-type');\r\n      if (jsonContentType.test(contentType))\r\n        return res.json()\r\n        .then(function (json) {\r\n          return new Response(new Blob([\r\n            'System.register([],function(e){return{execute:function(){e(\"default\",' + JSON.stringify(json) + ')}}})'\r\n          ], {\r\n            type: 'application/javascript'\r\n          }));\r\n        });\r\n      if (cssContentType.test(contentType))\r\n        return res.text()\r\n        .then(function (source) {\r\n          source = source.replace(/url\\(\\s*(?:([\"'])((?:\\\\.|[^\\n\\\\\"'])+)\\1|((?:\\\\.|[^\\s,\"'()\\\\])+))\\s*\\)/g, function (match, quotes, relUrl1, relUrl2) {\r\n            return 'url(' + quotes + resolveUrl(relUrl1 || relUrl2, url) + quotes + ')';\r\n          });\r\n          return new Response(new Blob([\r\n            'System.register([],function(e){return{execute:function(){var s=new CSSStyleSheet();s.replaceSync(' + JSON.stringify(source) + ');e(\"default\",s)}}})'\r\n          ], {\r\n            type: 'application/javascript'\r\n          }));\r\n        });\r\n      if (wasmContentType.test(contentType))\r\n        return (WebAssembly.compileStreaming ? WebAssembly.compileStreaming(res) : res.arrayBuffer().then(WebAssembly.compile))\r\n        .then(function (module) {\r\n          if (!global.PentaSystem.wasmModules)\r\n            global.PentaSystem.wasmModules = Object.create(null);\r\n          global.PentaSystem.wasmModules[url] = module;\r\n          // we can only set imports if supported (eg early Safari doesnt support)\r\n          var deps = [];\r\n          var setterSources = [];\r\n          if (WebAssembly.Module.imports)\r\n            WebAssembly.Module.imports(module).forEach(function (impt) {\r\n              var key = JSON.stringify(impt.module);\r\n              if (deps.indexOf(key) === -1) {\r\n                deps.push(key);\r\n                setterSources.push('function(m){i[' + key + ']=m}');\r\n              }\r\n            });\r\n          return new Response(new Blob([\r\n            'System.register([' + deps.join(',') + '],function(e){var i={};return{setters:[' + setterSources.join(',') +\r\n            '],execute:function(){return WebAssembly.instantiate(System.wasmModules[' + JSON.stringify(url) +\r\n            '],i).then(function(m){e(m.exports)})}}})'\r\n          ], {\r\n            type: 'application/javascript'\r\n          }));\r\n        });\r\n      return res;\r\n    });\r\n  };\r\n})(typeof self !== 'undefined' ? self : global);\r\n"],"names":["resolveIfNotPlainOrUrl","relUrl","parentUrl","indexOf","replace","slice","length","pathname","parentProtocol","segmented","lastIndexOf","output","segmentIndex","i","push","pop","join","baseUrl","document","baseEl","querySelector","href","location","lastSepIndex","split","global","systemJSPrototype","PentaSystem","constructor","prototype","moduleTypesRegEx","shouldFetch","url","test","jsonContentType","cssContentType","wasmContentType","fetch","options","then","res","passThrough","ok","contentType","headers","get","json","Response","Blob","JSON","stringify","type","text","source","match","quotes","relUrl1","relUrl2","WebAssembly","compileStreaming","arrayBuffer","compile","module","wasmModules","Object","create","deps","setterSources","Module","imports","forEach","impt","key","self"],"mappings":"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"}